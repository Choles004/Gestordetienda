<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Caja - Gestiona Fácil</title>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Reuse common styles */
        :root {
            --bg-color: #f0f2f5;
            --sidebar-bg: #ffffff;
            --content-bg: #f0f2f5;
            --card-bg-color: #ffffff;
            --text-color: #333333;
            --text-muted-color: #6c757d;
            --primary-color: #007bff;
            --primary-hover-color: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover-color: #5a6268;
            --success-color: #28a745;
            --success-hover-color: #1e7e34;
            --danger-color: #dc3545;
            --danger-hover-color: #c82333;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
             --info-hover-color: #117a8b;
            --link-color: #007bff;
            --link-active-color: #0056b3;
            --input-bg-color: #ffffff;
            --input-border-color: #ced4da;
            --input-focus-border-color: #80bdff;
            --border-color: #e9ecef;
            --border-radius-lg: 16px;
            --border-radius-md: 8px;
            --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --sidebar-width: 240px;
            --transition-speed: 0.3s;
        }

        /* Dark Theme Variables */
        body.dark-theme {
            --bg-color: #1a1d21;
            --sidebar-bg: #212529;
            --content-bg: #1a1d21;
            --card-bg-color: #2c3034;
            --text-color: #e9ecef;
            --text-muted-color: #adb5bd;
            --primary-color: #3498db;
            --primary-hover-color: #5dade2;
            --secondary-color: #adb5bd;
            --secondary-hover-color: #ced4da;
            --success-color: #20c997;
            --success-hover-color: #1aab88;
            --danger-color: #e74c3c;
            --danger-hover-color: #ff6b6b;
            --warning-color: #fdc107;
            --info-color: #3498db;
             --info-hover-color: #5dade2;
            --link-color: #3498db;
            --link-active-color: #5dade2;
            --input-bg-color: #3a3f44;
            --input-border-color: #555555;
            --input-focus-border-color: #3498db;
            --border-color: #3a3f44;
            select { background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="%23aaa" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>') !important; }
             .cash-status, .cash-actions > div, .cash-history .table-container { background-color: var(--card-bg-color); }
             .summary-section { border-color: var(--border-color); }
              #history-table th { background-color: rgba(255,255,255,0.05); }
        }

         * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; margin: 0; background-color: var(--bg-color); color: var(--text-color); transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; font-size: 15px; }

        /* Sidebar Styles */
         .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); padding: 20px 15px; height: 100vh; position: fixed; top: 0; left: 0; border-right: 1px solid var(--border-color); box-shadow: 2px 0 5px rgba(0,0,0,0.05); transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease; display: flex; flex-direction: column; overflow-y: auto; }
         .sidebar h2 { margin-top: 0; margin-bottom: 5px; color: var(--primary-color); font-size: 1.6em; text-align: center; }
         .sidebar .business-info { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color); }
          .sidebar .business-info small { font-size: 0.85em; color: var(--text-muted-color); }
         .sidebar ul { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .sidebar ul li a { text-decoration: none; color: var(--text-muted-color); display: flex; align-items: center; gap: 10px; padding: 10px 15px; margin-bottom: 5px; border-radius: var(--border-radius-md); transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; font-weight: 500; }
        .sidebar ul li a i { width: 18px; text-align: center; font-size: 1.1em; color: var(--text-muted-color); transition: color var(--transition-speed) ease; }
        .sidebar ul li a:hover { background-color: rgba(0, 123, 255, 0.05); color: var(--link-hover-color); }
        .sidebar ul li a:hover i { color: var(--link-hover-color); }
        .sidebar ul li a.active { background-color: var(--primary-color); color: #ffffff; font-weight: 600; }
         .sidebar ul li a.active i { color: #ffffff; }
         .sidebar .logout-link { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .sidebar .logout-link a { color: var(--danger-color); }
         .sidebar .logout-link a i { color: var(--danger-color); }
        .sidebar .logout-link a:hover { background-color: rgba(220, 53, 69, 0.1); color: var(--danger-color); }

        /* Content Area */
        .content { flex-grow: 1; padding: 25px 30px; margin-left: var(--sidebar-width); display: flex; flex-direction: column; }
        .content header { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
         .content header h1 { margin: 0 0 5px 0; font-size: 1.8em; font-weight: 600; }
         .content header p { margin: 0; color: var(--text-muted-color); }

        /* Cash Status Section */
         .cash-status {
            border: 1px solid var(--border-color);
            padding: 20px 25px;
            margin-bottom: 30px;
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--box-shadow);
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
             gap: 15px;
        }
        .cash-status h2 {
             grid-column: 1 / -1; /* Span full width */
             margin-top: 0;
             margin-bottom: 10px;
             font-size: 1.4em;
             font-weight: 600;
             border-bottom: 1px solid var(--border-color);
             padding-bottom: 10px;
         }
        .status-item {
             display: flex;
             flex-direction: column;
         }
         .status-item strong {
             font-size: 0.9em;
             color: var(--text-muted-color);
             margin-bottom: 5px;
             text-transform: uppercase;
             letter-spacing: 0.5px;
         }
         .status-item span {
             font-size: 1.2em;
             font-weight: 500;
         }
         #status-text.open { color: var(--success-color); font-weight: bold; }
         #status-text.closed { color: var(--danger-color); font-weight: bold; }

        /* Cash Actions (Open/Close Forms) */
         .cash-actions > div { /* Style both open and close sections */
            border: 1px solid var(--border-color);
            padding: 25px 30px;
            margin-bottom: 30px;
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--box-shadow);
         }
        .cash-actions h3 {
             margin-top: 0;
             margin-bottom: 25px;
             font-size: 1.3em;
             font-weight: 600;
             display: flex;
             align-items: center;
             gap: 10px;
         }
          #open-cash-section h3 i { color: var(--success-color); }
          #close-cash-section h3 i { color: var(--danger-color); }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; color: var(--text-muted-color); }
         .input-with-suffix { display: flex; align-items: center; max-width: 300px; }
         .input-with-suffix input { flex-grow: 1; border-top-right-radius: 0; border-bottom-right-radius: 0; }
         .input-with-suffix span { padding: 12px; background-color: var(--bg-color); border: 1px solid var(--input-border-color); border-left: none; border-radius: 0 var(--border-radius-md) var(--border-radius-md) 0; font-size: 1rem; color: var(--text-muted-color); }
         body.dark-theme .input-with-suffix span { background-color: var(--input-bg-color); border-color: var(--input-border-color); }
        .form-group input[type="number"] {
            /* width: 100%; */ /* Taken care by input-with-suffix */
            padding: 12px 15px;
            box-sizing: border-box;
            border: 1px solid var(--input-border-color);
            border-radius: var(--border-radius-md);
            background-color: var(--input-bg-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
         .form-group input[type="number"]:focus { border-color: var(--input-focus-border-color); outline: none; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); }

         .action-button {
            padding: 12px 25px;
            font-size: 1.05em;
            font-weight: 500;
            cursor: pointer;
            border: none;
            border-radius: var(--border-radius-md);
            transition: all var(--transition-speed) ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 10px; /* Space between buttons */
         }
          .open-cash { background-color: var(--success-color); color: white; }
          .open-cash:hover { background-color: var(--success-hover-color); transform: translateY(-2px); }
          .close-cash { background-color: var(--danger-color); color: white; }
          .close-cash:hover { background-color: var(--danger-hover-color); transform: translateY(-2px); }
           .download-summary { background-color: var(--info-color); color: white; }
          .download-summary:hover { background-color: var(--info-hover-color); transform: translateY(-2px); }
          .action-button:disabled { background-color: var(--secondary-color); opacity: 0.7; cursor: not-allowed; transform: none; }


         /* Summary Section within Close Form */
        .summary-section { margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .summary-section h4 { margin-top: 0; margin-bottom: 15px; font-weight: 600; color: var(--text-muted-color); }
        .summary-section p { margin: 8px 0; display: flex; justify-content: space-between; font-size: 1em; }
         .summary-section strong { font-weight: 600; }
         .summary-section .label { color: var(--text-muted-color); min-width: 180px; } /* For alignment */
         .summary-section .value { font-weight: 500; }
         #summary-expected strong { font-size: 1.1em; color: var(--primary-color); }
         .difference { font-weight: bold; font-size: 1.1em; }
         .difference.positive { color: var(--success-color); }
         .difference.negative { color: var(--danger-color); }

        /* History Section */
        .cash-history { margin-top: 30px; }
        .cash-history h2 { margin-bottom: 20px; font-size: 1.4em; font-weight: 600; }
        .table-container { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); overflow: auto; box-shadow: var(--box-shadow); margin-bottom: 25px; }
        #history-table { width: 100%; border-collapse: collapse; margin: 0; min-width: 800px; /* Ensure minimum width for horizontal scroll */}
        #history-table th, #history-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.9em; }
        #history-table th { background-color: rgba(0,0,0,0.02); body.dark-theme & { background-color: rgba(255,255,255,0.03); } font-weight: 600; color: var(--text-muted-color); text-transform: uppercase; letter-spacing: 0.5px; }
        #history-table tbody tr:last-child td { border-bottom: none; }
         #history-table td.positive { color: var(--success-color); font-weight: 500; }
         #history-table td.negative { color: var(--danger-color); font-weight: 500; }

        /* Error & Messages */
        .error { color: var(--danger-color); font-size: 0.85em; margin-top: 15px; background-color: rgba(220, 53, 69, 0.05); border: 1px solid rgba(220, 53, 69, 0.1); padding: 8px 12px; border-radius: var(--border-radius-md); text-align: center; }
         .error i { margin-right: 5px; }
        .hidden { display: none; }
        #no-history-message { text-align: center; padding: 20px; color: var(--text-muted-color); background-color: rgba(0,0,0,0.02); body.dark-theme & { background-color: rgba(255,255,255,0.03); } border-radius: var(--border-radius-md); }

         /* Theme Toggle Button */
         .theme-toggle { position: fixed; top: 15px; right: 15px; background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: var(--text-color); font-size: 1.2em; transition: all var(--transition-speed) ease; z-index: 1000; }
         .theme-toggle:hover { transform: scale(1.1); }

         /* Responsive Adjustments */
         @media (max-width: 768px) {
             /* Sidebar adjustments */
              .sidebar { width: 100%; height: auto; position: static; border-right: none; border-bottom: 1px solid var(--border-color); flex-direction: row; overflow-x: auto; padding: 10px 15px; box-shadow: none; }
             .sidebar h2, .sidebar .business-info { display: none; }
             .sidebar ul { display: flex; flex-direction: row; flex-grow: 0; flex-wrap: nowrap; }
             .sidebar ul li a { padding: 8px 10px; margin-bottom: 0; margin-right: 5px; }
             .sidebar ul li a span { display: none; }
             .sidebar ul li a i { font-size: 1.3em; margin: 0; color: var(--text-muted-color); }
             .sidebar ul li a.active i { color: var(--primary-color); }
             .sidebar ul li a.active { background-color: transparent; }
             .sidebar .logout-link { margin-top: 0; padding-top: 0; border-top: none; margin-left: auto; }
             .sidebar .logout-link a { padding: 8px 10px; }

             /* Content adjustments */
             .content { margin-left: 0; padding: 20px 15px; }
             .content header h1 { font-size: 1.6em; }
             .cash-status { grid-template-columns: 1fr 1fr; padding: 15px; } /* Stack status better */
             .cash-actions > div { padding: 20px; }
             .input-with-suffix { max-width: none; } /* Allow full width */
             .summary-section p { flex-direction: column; align-items: flex-start; gap: 2px; }
             .summary-section .label { min-width: 0; }
             .action-button { width: 100%; margin-bottom: 10px; margin-right: 0; justify-content: center; } /* Stack buttons */
             .table-container { margin-left: -15px; margin-right: -15px; border-radius: 0; border-left: none; border-right: none;} /* Full width table */
             .theme-toggle { top: 10px; right: 10px; width: 35px; height: 35px; font-size: 1.1em; }
         }
    </style>
</head>
<body class=""> <!-- Theme class added by JS -->

     <!-- Theme toggle button -->
    <button id="theme-toggle-button" class="theme-toggle" title="Cambiar Tema">
        <i class="fas fa-sun"></i> <!-- Default to light icon -->
    </button>

     <nav class="sidebar">
        <h2>Gestiona Fácil</h2>
        <div class="business-info">
            <small id="business-name-sidebar">Cargando...</small>
         </div>
         <ul>
            <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
            <li><a href="nueva_venta.html"><i class="fas fa-cash-register"></i> <span>Nueva Venta</span></a></li>
            <li><a href="restaurante.html" id="restaurant-link" class="hidden"><i class="fas fa-utensils"></i> <span>Restaurante</span></a></li>
            <li><a href="caja.html" class="active"><i class="fas fa-cash-register"></i> <span>Caja</span></a></li>
            <li><a href="productos.html"><i class="fas fa-box-open"></i> <span>Productos</span></a></li>
            <li><a href="inventario.html"><i class="fas fa-clipboard-list"></i> <span>Inventario</span></a></li>
            <li><a href="proveedores.html"><i class="fas fa-truck"></i> <span>Proveedores</span></a></li>
            <li><a href="clientes.html"><i class="fas fa-users"></i> <span>Clientes</span></a></li>
            <li><a href="gastos.html"><i class="fas fa-file-invoice-dollar"></i> <span>Gastos</span></a></li>
            <li><a href="reportes.html"><i class="fas fa-chart-line"></i> <span>Reportes</span></a></li>
            <li><a href="configuracion.html"><i class="fas fa-cog"></i> <span>Configuración</span></a></li>
        </ul>
         <div class="logout-link">
             <li><a href="login.html" id="logout-button"><i class="fas fa-sign-out-alt"></i> <span>Salir</span></a></li>
         </div>
    </nav>

    <main class="content">
        <header>
            <h1>Gestión de Caja</h1>
            <p>Abre la caja al iniciar el día y ciérrala al terminar.</p>
        </header>

        <section class="cash-status">
            <h2><i class="fas fa-info-circle" style="color: var(--info-color);"></i> Estado Actual</h2>
            <div class="status-item">
                <strong>Estado:</strong>
                <span id="status-text" class="closed">Cerrada</span>
            </div>
            <div class="status-item">
                 <strong>Abierta desde:</strong>
                 <span id="open-time-text">-</span>
            </div>
             <div class="status-item">
                 <strong>Fondo Inicial:</strong>
                 <span id="initial-fund-text">-</span>
            </div>
        </section>

        <section class="cash-actions">
             <!-- Formulario para Abrir Caja -->
            <div id="open-cash-section">
                <h3><i class="fas fa-door-open"></i> Abrir Caja</h3>
                <form id="open-cash-form">
                    <div class="form-group">
                        <label for="initial-fund">Fondo Inicial (Efectivo):</label>
                         <div class="input-with-suffix">
                            <input type="number" id="initial-fund" step="0.01" min="0" required placeholder="0.00">
                            <span class="currency-symbol">$</span>
                         </div>
                    </div>
                    <p id="open-error" class="error hidden"><i class="fas fa-exclamation-circle"></i> <span></span></p>
                    <button type="submit" class="action-button open-cash"><i class="fas fa-play-circle"></i> Abrir Caja Ahora</button>
                </form>
            </div>

             <!-- Formulario para Cerrar Caja -->
             <div id="close-cash-section" class="hidden">
                 <h3><i class="fas fa-door-closed"></i> Cerrar Caja</h3>
                 <form id="close-cash-form">
                     <div class="summary-section">
                         <h4>Resumen Calculado</h4>
                         <p><span class="label">Fondo Inicial:</span> <span class="value" id="summary-initial">0.00</span></p>
                         <p><span class="label">(+) Ventas Efectivo:</span> <span class="value" id="summary-cash-sales">0.00</span></p>
                         <p><span class="label">(-) Gastos Efectivo:</span> <span class="value" id="summary-cash-expenses">0.00</span></p>
                         <hr style="border-top: 1px dashed var(--border-color); margin: 10px 0;">
                         <p><span class="label">(=) Efectivo Esperado:</span> <strong class="value" id="summary-expected">0.00</strong></p>
                     </div>

                     <div class="form-group" style="margin-top: 25px;">
                         <label for="actual-cash">Conteo Real de Efectivo en Caja:</label>
                         <div class="input-with-suffix">
                            <input type="number" id="actual-cash" step="0.01" min="0" required placeholder="0.00">
                            <span class="currency-symbol">$</span>
                         </div>
                     </div>

                      <div class="summary-section">
                         <h4>Resultado del Cierre</h4>
                         <p><span class="label">Efectivo Contado:</span> <span class="value" id="summary-counted">0.00</span></p>
                         <p><span class="label">Diferencia (Sobrante/Faltante):</span> <span id="summary-difference" class="value difference">0.00</span></p>
                         <hr style="border-top: 1px dashed var(--border-color); margin: 10px 0;">
                         <p><span class="label">Ventas Tarjeta:</span> <span class="value" id="summary-card-sales">0.00</span></p>
                         <p><span class="label">Ventas Transferencia:</span> <span class="value" id="summary-transfer-sales">0.00</span></p>
                     </div>

                     <p id="close-error" class="error hidden"><i class="fas fa-exclamation-circle"></i> <span></span></p>
                     <div style="margin-top: 25px;">
                        <button type="submit" class="action-button close-cash"><i class="fas fa-stop-circle"></i> Confirmar Cierre</button>
                        <button type="button" id="download-summary-button" class="action-button download-summary hidden">
                            <i class="fas fa-download"></i> Descargar Resumen
                        </button>
                     </div>
                 </form>
             </div>
        </section>

        <section class="cash-history">
            <h2><i class="fas fa-history" style="color: var(--secondary-color);"></i> Historial de Cierres de Caja</h2>
             <div class="table-container">
                 <table id="history-table">
                     <thead>
                         <tr>
                             <th>Fecha Cierre</th>
                             <th>Hora Apertura</th>
                             <th>Hora Cierre</th>
                             <th>Fondo Inicial</th>
                             <th>Efectivo Esperado</th>
                             <th>Efectivo Contado</th>
                             <th>Diferencia</th>
                             <th>Ventas Tarjeta</th>
                             <th>Ventas Transf.</th>
                         </tr>
                     </thead>
                     <tbody id="history-table-body">
                         <!-- Rows loaded by JS -->
                     </tbody>
                 </table>
             </div>
             <p id="no-history-message" class="hidden">Aún no hay cierres de caja registrados.</p>
        </section>

    </main>

     <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Theme Management ---
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const body = document.body;
            const themeIcon = themeToggleButton.querySelector('i');
            function setTheme(theme) { if (theme === 'dark') { body.classList.add('dark-theme'); themeIcon.classList.remove('fa-sun'); themeIcon.classList.add('fa-moon'); localStorage.setItem('theme', 'dark'); } else { body.classList.remove('dark-theme'); themeIcon.classList.remove('fa-moon'); themeIcon.classList.add('fa-sun'); localStorage.setItem('theme', 'light'); } }
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            themeToggleButton.addEventListener('click', () => { const currentTheme = localStorage.getItem('theme') || 'light'; setTheme(currentTheme === 'light' ? 'dark' : 'light'); });


            // --- Business Info & Currency & Restaurant Link ---
             let currency = '$';
            try {
                const businessName = localStorage.getItem('businessName') || 'Mi Negocio';
                document.getElementById('business-name-sidebar').textContent = businessName;
                 currency = localStorage.getItem('currency') || '$';
                 document.querySelectorAll('.currency-symbol').forEach(el => el.textContent = currency);
                 const isRestaurant = localStorage.getItem('businessType') === 'restaurant';
                 document.getElementById('restaurant-link').classList.toggle('hidden', !isRestaurant);
            } catch(e) { console.error("Error loading config", e); }


            // --- Elementos UI Caja ---
            const statusText = document.getElementById('status-text');
            const openTimeText = document.getElementById('open-time-text');
            const initialFundText = document.getElementById('initial-fund-text');
            const openCashSection = document.getElementById('open-cash-section');
            const closeCashSection = document.getElementById('close-cash-section');
            const openCashForm = document.getElementById('open-cash-form');
            const closeCashForm = document.getElementById('close-cash-form');
            const initialFundInput = document.getElementById('initial-fund');
            const actualCashInput = document.getElementById('actual-cash');
            const downloadButton = document.getElementById('download-summary-button');
            const historyTableBody = document.getElementById('history-table-body');
            const noHistoryMessage = document.getElementById('no-history-message');
            const openError = document.getElementById('open-error');
            const openErrorSpan = openError.querySelector('span');
            const closeError = document.getElementById('close-error');
            const closeErrorSpan = closeError.querySelector('span');

            // Summary elements in close form
            const summaryInitial = document.getElementById('summary-initial');
            const summaryCashSales = document.getElementById('summary-cash-sales');
            const summaryCashExpenses = document.getElementById('summary-cash-expenses');
            const summaryExpected = document.getElementById('summary-expected');
            const summaryCounted = document.getElementById('summary-counted');
            const summaryDifference = document.getElementById('summary-difference');
            const summaryCardSales = document.getElementById('summary-card-sales');
            const summaryTransferSales = document.getElementById('summary-transfer-sales');

            let cashRegisterStatus = {}; // { isOpen: boolean, openTime: string, initialFund: number }
            let cashHistory = []; // Array de objetos de cierre


            // --- Utility Functions ---
             function formatCurrency(amount) {
                 return `${currency}${amount.toFixed(2)}`;
             }
             function displayError(errorElement, errorSpan, message) {
                 errorSpan.textContent = message;
                 errorElement.classList.remove('hidden');
             }
             function hideError(errorElement) {
                 errorElement.classList.add('hidden');
             }

            // --- Carga Inicial ---
            loadCashRegisterState();
            loadCashHistory();
            updateUI();

            // --- Event Listeners ---
            openCashForm.addEventListener('submit', (e) => {
                e.preventDefault();
                hideError(openError);
                const initialFund = parseFloat(initialFundInput.value);

                if (isNaN(initialFund) || initialFund < 0) {
                     displayError(openError, openErrorSpan, 'El fondo inicial debe ser un número válido y no negativo.');
                     initialFundInput.focus();
                     return;
                }

                openCashRegister(initialFund);
                updateUI();
            });

            closeCashForm.addEventListener('submit', (e) => {
                 e.preventDefault();
                 hideError(closeError);
                 const actualCash = parseFloat(actualCashInput.value);

                 if (isNaN(actualCash) || actualCash < 0) {
                     displayError(closeError, closeErrorSpan, 'El conteo real de efectivo debe ser un número válido y no negativo.');
                     actualCashInput.focus();
                     return;
                 }

                 // Confirmation before closing
                 if (confirm('¿Estás seguro de que deseas cerrar la caja con este monto contado? Esta acción no se puede deshacer.')) {
                     closeCashRegister(actualCash);
                     updateUI(); // Reflect closed state immediately
                     downloadButton.classList.remove('hidden'); // Show download button after confirmation
                 }
            });

             downloadButton.addEventListener('click', downloadSummary);


            // --- Functions ---
            function loadCashRegisterState() {
                 try {
                     cashRegisterStatus = JSON.parse(localStorage.getItem('cashRegisterStatus') || '{}');
                 } catch (error) {
                     console.error("Error cargando estado de caja:", error);
                     cashRegisterStatus = {};
                 }
            }

            function saveCashRegisterState() {
                 try {
                     localStorage.setItem('cashRegisterStatus', JSON.stringify(cashRegisterStatus));
                 } catch (error) {
                      console.error("Error guardando estado de caja:", error);
                      displayError(cashRegisterStatus.isOpen ? closeError : openError, cashRegisterStatus.isOpen ? closeErrorSpan : openErrorSpan, "Error al guardar el estado de la caja.");
                 }
            }

             function loadCashHistory() {
                try {
                    cashHistory = JSON.parse(localStorage.getItem('cashHistory') || '[]');
                    renderHistoryTable();
                } catch (error) {
                    console.error("Error cargando historial de caja:", error);
                    cashHistory = [];
                     renderHistoryTable(); // Render empty state
                }
            }

             function saveCashHistory() {
                try {
                    localStorage.setItem('cashHistory', JSON.stringify(cashHistory));
                } catch (error) {
                    console.error("Error guardando historial de caja:", error);
                    displayError(closeError, closeErrorSpan, "Error al guardar el historial de caja.");
                }
            }


            function updateUI() {
                if (cashRegisterStatus.isOpen) {
                    statusText.textContent = 'Abierta';
                    statusText.className = 'open'; // Class for styling
                    openTimeText.textContent = new Date(cashRegisterStatus.openTime).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' });
                    initialFundText.textContent = formatCurrency(cashRegisterStatus.initialFund);
                    openCashSection.classList.add('hidden');
                    closeCashSection.classList.remove('hidden');
                    calculateAndDisplaySummary(); // Calculate and display summary for closing
                    downloadButton.classList.add('hidden'); // Hide download until closed
                     actualCashInput.value = ''; // Clear previous count input
                     actualCashInput.focus(); // Focus on count input
                     hideError(closeError); // Hide errors when state changes
                } else {
                    statusText.textContent = 'Cerrada';
                     statusText.className = 'closed';
                    openTimeText.textContent = '-';
                    initialFundText.textContent = '-';
                    openCashSection.classList.remove('hidden');
                    closeCashSection.classList.add('hidden');
                    openCashForm.reset(); // Clear open form
                     initialFundInput.focus();
                     hideError(openError);
                }
                 renderHistoryTable(); // Always update history table
            }


            function openCashRegister(initialFund) {
                cashRegisterStatus = {
                    isOpen: true,
                    openTime: new Date().toISOString(),
                    initialFund: initialFund
                };
                saveCashRegisterState();
                console.log("Caja abierta:", cashRegisterStatus);
            }

             function calculateAndDisplaySummary() {
                 const openTimestamp = cashRegisterStatus.isOpen ? new Date(cashRegisterStatus.openTime).getTime() : 0;
                 let allSales = [];
                 let allExpenses = [];

                 try { allSales = JSON.parse(localStorage.getItem('ventas') || '[]'); }
                 catch(e) { console.error("Error reading sales", e); displayError(closeError, closeErrorSpan, "Error al leer ventas."); }
                 try { allExpenses = JSON.parse(localStorage.getItem('gastos') || '[]'); }
                 catch(e) { console.error("Error reading expenses", e); displayError(closeError, closeErrorSpan, "Error al leer gastos."); }


                 // Filter sales and expenses since the cash register was opened
                 const salesSinceOpen = allSales.filter(sale => new Date(sale.fecha).getTime() >= openTimestamp);
                 const expensesSinceOpen = allExpenses.filter(exp => new Date(exp.fecha).getTime() >= openTimestamp);

                 // Calculate totals by payment method
                 let cashSalesTotal = 0;
                 let cardSalesTotal = 0;
                 let transferSalesTotal = 0;
                 salesSinceOpen.forEach(sale => {
                     // Normalize payment method text if needed (e.g., handle variations)
                     const method = sale.metodoPago?.toLowerCase() || 'desconocido';
                     if (method.includes('efectivo')) {
                         cashSalesTotal += sale.total;
                     } else if (method.includes('tarjeta')) {
                         cardSalesTotal += sale.total;
                     } else if (method.includes('transferencia')) {
                         transferSalesTotal += sale.total;
                     }
                     // Add other methods if necessary
                 });

                 let cashExpensesTotal = 0;
                 expensesSinceOpen.forEach(exp => {
                      // Assuming expenses have metodoPagoId or similar
                      const method = exp.metodoPagoId?.toLowerCase() || exp.metodoPago?.toLowerCase() || 'desconocido';
                     if (method.includes('efectivo')) {
                         cashExpensesTotal += exp.monto;
                     }
                 });

                 const initialFund = cashRegisterStatus.initialFund || 0;
                 const expectedCash = initialFund + cashSalesTotal - cashExpensesTotal;

                 // Update the UI elements in the close form
                 summaryInitial.textContent = formatCurrency(initialFund);
                 summaryCashSales.textContent = formatCurrency(cashSalesTotal);
                 summaryCashExpenses.textContent = formatCurrency(cashExpensesTotal);
                 summaryExpected.textContent = formatCurrency(expectedCash);
                 summaryCardSales.textContent = formatCurrency(cardSalesTotal);
                 summaryTransferSales.textContent = formatCurrency(transferSalesTotal);

                  // Also update the difference section based on current actual cash input
                  const actualCash = parseFloat(actualCashInput.value) || 0;
                  const difference = actualCash - expectedCash;
                  summaryCounted.textContent = formatCurrency(actualCash);
                  summaryDifference.textContent = formatCurrency(difference);
                  summaryDifference.className = 'value difference'; // Reset class
                  if (difference > 0) summaryDifference.classList.add('positive');
                  if (difference < 0) summaryDifference.classList.add('negative');


                 return { // Return calculated values for use in closeCashRegister
                     initialFund, cashSalesTotal, cashExpensesTotal, expectedCash,
                     cardSalesTotal, transferSalesTotal, salesSinceOpen, expensesSinceOpen
                 };
            }

             // Add listener to recalculate difference when user types in actual cash
            actualCashInput.addEventListener('input', () => {
                if (cashRegisterStatus.isOpen) {
                    calculateAndDisplaySummary(); // Recalculate summary including difference
                }
            });


            function closeCashRegister(actualCash) {
                 if (!cashRegisterStatus.isOpen) {
                     alert("La caja ya está cerrada.");
                     return;
                 }

                const summaryData = calculateAndDisplaySummary(); // Get final calculated data
                const closeTime = new Date().toISOString();
                const difference = actualCash - summaryData.expectedCash;

                 // Final update to UI difference section (redundant? calculateAndDisplaySummary already does it)
                 // summaryCounted.textContent = formatCurrency(actualCash);
                 // summaryDifference.textContent = formatCurrency(difference);
                 // summaryDifference.className = 'value difference';
                 // if (difference > 0) summaryDifference.classList.add('positive');
                 // if (difference < 0) summaryDifference.classList.add('negative');


                 const closingRecord = {
                     id: `cierre_${Date.now()}`,
                     openTime: cashRegisterStatus.openTime,
                     closeTime: closeTime,
                     initialFund: summaryData.initialFund,
                     cashSales: summaryData.cashSalesTotal,
                     cashExpenses: summaryData.cashExpensesTotal,
                     expectedCash: summaryData.expectedCash,
                     countedCash: actualCash,
                     difference: difference,
                     cardSales: summaryData.cardSalesTotal,
                     transferSales: summaryData.transferSalesTotal,
                     // Optional: Store simplified list of sales/expenses IDs or details for audit
                     // salesDetails: summaryData.salesSinceOpen.map(s => ({id: s.id, total: s.total, metodo: s.metodoPago})),
                     // expensesDetails: summaryData.expensesSinceOpen.map(e => ({id: e.id, monto: e.monto, cat: e.categoria})),
                 };

                 cashHistory.push(closingRecord);
                 saveCashHistory();

                 cashRegisterStatus = { isOpen: false }; // Reset status
                 saveCashRegisterState();

                 console.log("Caja cerrada. Registro:", closingRecord);
                 alert("Caja cerrada exitosamente.");
                 // UI update happens via the main updateUI call after this function returns
            }

             function renderHistoryTable() {
                 historyTableBody.innerHTML = '';
                 noHistoryMessage.classList.toggle('hidden', cashHistory.length > 0);

                 if (cashHistory.length > 0) {
                     const sortedHistory = [...cashHistory].sort((a, b) => new Date(b.closeTime) - new Date(a.closeTime));

                     sortedHistory.forEach(record => {
                         const row = historyTableBody.insertRow();
                         const diff = record.difference;
                         const diffClass = diff > 0 ? 'positive' : (diff < 0 ? 'negative' : '');

                         row.innerHTML = `
                             <td>${new Date(record.closeTime).toLocaleDateString('es-ES')}</td>
                             <td>${new Date(record.openTime).toLocaleTimeString('es-ES', { hour:'2-digit', minute:'2-digit' })}</td>
                             <td>${new Date(record.closeTime).toLocaleTimeString('es-ES', { hour:'2-digit', minute:'2-digit' })}</td>
                             <td>${formatCurrency(record.initialFund)}</td>
                             <td>${formatCurrency(record.expectedCash)}</td>
                             <td>${formatCurrency(record.countedCash)}</td>
                             <td class="${diffClass}">${formatCurrency(diff)}</td>
                             <td>${formatCurrency(record.cardSales)}</td>
                              <td>${formatCurrency(record.transferSales)}</td>
                         `;
                     });
                 }
             }

             function downloadSummary() {
                 if (cashHistory.length === 0) {
                     alert("No hay historial de cierres para descargar.");
                     return;
                 }
                 // Find the record associated with the *last* closure (which might not be the last in the array if loaded unsorted)
                 // Assume the last element is the most recent one we just added/loaded sorted.
                  const lastClosing = cashHistory[cashHistory.length - 1];

                  if (!lastClosing || !lastClosing.closeTime) {
                     alert("No se encontró el último registro de cierre válido.");
                     return;
                 }

                 // Build the text content for the summary file
                 let summaryContent = `Resumen de Caja - Cierre ${new Date(lastClosing.closeTime).toLocaleString('es-ES')}\n`;
                 summaryContent += "=================================================\n";
                 summaryContent += ` Apertura:          ${new Date(lastClosing.openTime).toLocaleString('es-ES')}\n`;
                 summaryContent += ` Cierre:            ${new Date(lastClosing.closeTime).toLocaleString('es-ES')}\n`;
                 summaryContent += "-------------------------------------------------\n";
                 summaryContent += ` Fondo Inicial:       ${formatCurrency(lastClosing.initialFund)}\n`;
                 summaryContent += ` (+) Ventas Efectivo: ${formatCurrency(lastClosing.cashSales)}\n`;
                 summaryContent += ` (-) Gastos Efectivo: ${formatCurrency(lastClosing.cashExpenses)}\n`;
                 summaryContent += ` (=) Efectivo Esperado:${formatCurrency(lastClosing.expectedCash)}\n`;
                 summaryContent += "-------------------------------------------------\n";
                 summaryContent += ` Efectivo Contado:    ${formatCurrency(lastClosing.countedCash)}\n`;
                 const diffText = lastClosing.difference > 0 ? 'SOBRANTE' : lastClosing.difference < 0 ? 'FALTANTE' : 'EXACTO';
                 summaryContent += ` Diferencia:          ${formatCurrency(lastClosing.difference)} (${diffText})\n`;
                 summaryContent += "-------------------------------------------------\n";
                 summaryContent += ` Ventas Tarjeta:      ${formatCurrency(lastClosing.cardSales)}\n`;
                 summaryContent += ` Ventas Transferencia:${formatCurrency(lastClosing.transferSales)}\n`;
                 summaryContent += "=================================================\n";
                 // Optional: Add details of sales/expenses if stored in the record
                 // summaryContent += "\nDetalle Ventas (Resumen):\n";
                 // lastClosing.salesDetails?.forEach(s => summaryContent += `- Venta ${s.id}: ${formatCurrency(s.total)} (${s.metodo})\n`);
                 // summaryContent += "\nDetalle Gastos (Resumen):\n";
                 // lastClosing.expensesDetails?.forEach(e => summaryContent += `- Gasto ${e.id}: ${formatCurrency(e.monto)} (${e.cat})\n`);


                 const blob = new Blob([summaryContent], { type: 'text/plain;charset=utf-8' });
                 const link = document.createElement('a');
                 link.href = URL.createObjectURL(blob);
                 const dateStr = new Date(lastClosing.closeTime).toISOString().split('T')[0];
                 link.download = `cierre_caja_${dateStr}.txt`;

                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);

                 console.log("Resumen de cierre descargado.");
             }


            // --- Lógica botón Salir ---
            document.getElementById('logout-button')?.addEventListener('click', (e) => {
                e.preventDefault();
                if (cashRegisterStatus.isOpen) {
                    alert("¡Atención! La caja está abierta. Debes cerrarla antes de salir.");
                } else if (confirm('¿Estás seguro de que quieres salir?')) {
                    window.location.href = 'login.html';
                }
            });
        });
    </script>

</body>
</html>